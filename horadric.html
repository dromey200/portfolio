<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horadric AI - Sanctuary Systems</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #d32f2f;
            --button-hover: #b71c1c;
            --disabled-color: #555;
            --modal-overlay: rgba(0, 0, 0, 0.85);

            /* Diablo Rarity Colors */
            --color-common: #adadad;
            --color-magic: #6969ff;
            --color-rare: #ffff00;
            --color-legendary: #ff8000;
            --color-unique: #c7b377;
            --color-mythic: #e770ff;
            --color-error: #ff3333;
            --color-success: #4caf50;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            color: var(--accent-color);
            font-family: 'Garamond', serif;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 5px;
        }

        .subtitle {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 20px;
            font-style: italic;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        /* Email Capture */
        .beta-signup {
            width: 100%;
            max-width: 600px;
            margin-bottom: 25px;
            text-align: center;
            padding: 15px;
            border: 1px dashed #444;
            border-radius: 8px;
            background: rgba(255,255,255,0.03);
        }
        
        .beta-form {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.7);
            border: 1px solid #333;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #aaa;
            font-size: 0.9rem;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .help-icon {
            background-color: #333;
            color: #ccc;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #555;
            transition: all 0.2s;
        }

        .help-icon:hover {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        input[type="text"], 
        input[type="password"],
        input[type="email"],
        select {
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #2c2c2c;
            color: white;
            font-size: 16px;
            width: 100%;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        input.error { border-color: var(--color-error); }

        input[type="file"] {
            margin-top: 5px;
            padding: 10px;
            background-color: #2c2c2c;
            border-radius: 4px;
            color: var(--text-color);
            cursor: pointer;
        }

        .input-hint {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }

        /* Demo Link Style */
        .demo-link {
            color: var(--accent-color);
            font-size: 0.85rem;
            text-decoration: underline;
            cursor: pointer;
            margin-top: 5px;
            display: inline-block;
        }
        .demo-link:hover { color: #fff; }

        .error-message {
            color: var(--color-error);
            font-size: 0.85rem;
            margin-top: 8px;
            padding: 8px 12px;
            background-color: rgba(255, 51, 51, 0.1);
            border-left: 3px solid var(--color-error);
            border-radius: 4px;
            display: none;
        }
        .error-message.show { display: block; }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover:not(:disabled) {
            background-color: var(--button-hover);
            transform: translateY(-1px);
        }

        button:disabled {
            background-color: var(--disabled-color);
            cursor: not-allowed;
            opacity: 0.7;
        }

        button.secondary {
            background-color: #333;
            border: 1px solid #555;
            color: #ccc;
            margin-top: 15px;
        }
        button.secondary:hover:not(:disabled) {
            background-color: #444;
            color: white;
        }

        #result-area {
            margin-top: 25px;
            white-space: pre-wrap;
            background-color: #181818;
            padding: 20px;
            border-radius: 4px;
            border-left: 6px solid #444;
            line-height: 1.6;
            display: none;
            word-wrap: break-word;
        }

        #result-area.rarity-common { border-left-color: var(--color-common); }
        #result-area.rarity-magic { border-left-color: var(--color-magic); box-shadow: -2px 0 15px -5px var(--color-magic); }
        #result-area.rarity-rare { border-left-color: var(--color-rare); box-shadow: -2px 0 15px -5px var(--color-rare); }
        
        #result-area.rarity-legendary,
        #result-area.rarity-ancestral-legendary {
            border-left-color: var(--color-legendary);
            box-shadow: -2px 0 20px -5px var(--color-legendary);
        }

        #result-area.rarity-unique,
        #result-area.rarity-ancestral-unique {
            border-left-color: var(--color-unique);
            box-shadow: -2px 0 20px -5px var(--color-unique);
        }

        #result-area.rarity-mythic,
        #result-area.rarity-ancestral-mythic {
            border-left-color: var(--color-mythic);
            box-shadow: -2px 0 25px -5px var(--color-mythic);
        }

        #result-area.error-state {
            border-left-color: var(--color-error);
            box-shadow: -2px 0 20px -5px var(--color-error);
        }

        #loading {
            display: none;
            text-align: center;
            margin-top: 20px;
            font-style: italic;
            color: #888;
        }

        .preview-img {
            max-width: 100%;
            margin-top: 15px;
            border-radius: 4px;
            border: 1px solid #444;
            display: none;
        }

        /* HISTORY SECTION */
        .history-section {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
        }

        .history-title {
            color: #888;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .clear-history {
            color: var(--accent-color);
            cursor: pointer;
            font-size: 0.8rem;
            text-decoration: underline;
        }

        .history-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .history-item {
            background-color: #252525;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #444;
        }

        .history-item:hover {
            background-color: #333;
            transform: translateX(5px);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: #aaa;
        }

        .history-name { font-weight: bold; color: #fff; font-size: 1rem; }
        .history-class { font-style: italic; color: #666; font-size: 0.8rem; }
        .h-rarity-legendary { border-left-color: var(--color-legendary); }
        .h-rarity-unique { border-left-color: var(--color-unique); }
        .h-rarity-mythic { border-left-color: var(--color-mythic); }
        .h-rarity-rare { border-left-color: var(--color-rare); }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--modal-overlay);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            border: 1px solid #555;
            position: relative;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
        }

        .modal-content h3 { margin-top: 0; color: var(--accent-color); text-transform: uppercase; }
        .modal-content ol { padding-left: 20px; line-height: 1.8; color: #ccc; }
        .modal-content code { background-color: #2c2c2c; padding: 2px 6px; border-radius: 3px; color: #4fc3f7; }
        
        .modal-close {
            position: absolute;
            top: 10px; right: 15px;
            background: none; border: none;
            color: #888; font-size: 28px;
            cursor: pointer; width: auto;
        }
        .modal-close:hover { color: white; background: transparent; transform: none; }

        .highlight-link { color: #4fc3f7; text-decoration: none; border-bottom: 1px dotted #4fc3f7; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <h1>Horadric AI</h1>
    <div class="subtitle">Sanctuary Systems v1.1 (Demo Mode)</div>

    <div class="beta-signup">
        <label style="justify-content: center; color: var(--accent-color);">ðŸ”¥ Join the Beta List</label>
        <p style="margin: 5px 0 10px; font-size: 0.9rem; color: #bbb;">Get updates when we release new features.</p>
        <form action="https://formspree.io/f/xwvvkqbj" method="POST" class="beta-form">
            <input type="email" name="email" placeholder="Wanderer@email.com" required>
            <button type="submit" style="width: auto; padding: 12px 25px;">Join</button>
        </form>
    </div>

    <div class="container">
        <div class="input-group">
            <label for="api-key">
                Gemini API Key
                <button id="help-trigger" class="help-icon" type="button" aria-label="Help: How to get an API key">?</button>
            </label>
            <input 
                type="password" 
                id="api-key" 
                placeholder="Paste key starting with AIza..."
                autocomplete="off"
            >
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <span id="api-key-hint" class="input-hint">Key is free & stored locally.</span>
                <span class="demo-link" onclick="runDemo()">No key? Try Demo</span>
            </div>
            <div id="api-key-error" class="error-message"></div>
        </div>

        <div class="input-group">
            <label for="player-class">Your Class</label>
            <select id="player-class">
                <option value="Any">Select Class (Optional)</option>
                <option value="Barbarian">Barbarian</option>
                <option value="Druid">Druid</option>
                <option value="Necromancer">Necromancer</option>
                <option value="Rogue">Rogue</option>
                <option value="Sorcerer">Sorcerer</option>
                <option value="Spiritborn">Spiritborn</option>
            </select>
            <span class="input-hint">Select for class-specific recommendations</span>
        </div>

        <div class="input-group">
            <label for="image-upload">Upload Loot Screenshot</label>
            <input type="file" id="image-upload" accept="image/png,image/jpeg,image/jpg,image/webp">
            <span class="input-hint">Max 10MB. Formats: PNG, JPEG, WebP</span>
            <div id="image-error" class="error-message"></div>
            <img id="image-preview" class="preview-img" alt="Uploaded item screenshot preview">
        </div>

        <button id="analyze-btn" type="button">Identify Item</button>

        <div id="loading">
            <p>Consulting the archives...</p>
        </div>

        <div id="result-area" aria-live="polite"></div>

        <button id="share-btn" class="secondary hidden" type="button">ðŸ“¢ Copy for Discord</button>
    </div>

    <div class="history-section" id="history-section" style="display:none;">
        <div class="history-title">
            <span>Journal (Recent Scans)</span>
            <span class="clear-history" onclick="clearHistory()">Clear All</span>
        </div>
        <div class="history-list" id="history-list"></div>
    </div>

    <div id="help-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close-btn" class="modal-close">&times;</button>
            <h3>How to get a Free Key</h3>
            <p>Horadric AI uses Google Gemini. You need a free key to use it.</p>
            <ol>
                <li>Go to <a href="https://aistudio.google.com/app/apikey" target="_blank" class="highlight-link">Google AI Studio</a>.</li>
                <li>Click <strong>"Create API Key"</strong>.</li>
                <li>Select "Create key in new project".</li>
                <li>Copy the code that starts with <code>AIza...</code></li>
                <li>Paste it into the API Key field above!</li>
            </ol>
            <div style="margin-top: 15px; font-size: 0.85rem; color: #888; border-top: 1px solid #444; padding-top: 10px;">
                <em>*Note: This key is free of charge for standard use.</em>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            MAX_FILE_SIZE: 10 * 1024 * 1024,
            ALLOWED_MIME_TYPES: ['image/png', 'image/jpeg', 'image/jpg', 'image/webp'],
            JSON_DELIMITER: '---METADATA---',
            GEMINI_MODEL: 'gemini-2.5-flash', 
            VALID_RARITIES: [
                'common', 'magic', 'rare', 'legendary', 'unique', 'mythic',
                'ancestral-legendary', 'ancestral-unique', 'ancestral-mythic'
            ]
        };

        // DOM Elements
        const elements = {
            apiKeyInput: document.getElementById('api-key'),
            apiKeyError: document.getElementById('api-key-error'),
            classInput: document.getElementById('player-class'),
            fileInput: document.getElementById('image-upload'),
            imageError: document.getElementById('image-error'),
            resultArea: document.getElementById('result-area'),
            loadingDiv: document.getElementById('loading'),
            previewImg: document.getElementById('image-preview'),
            shareBtn: document.getElementById('share-btn'),
            analyzeBtn: document.getElementById('analyze-btn'),
            modal: document.getElementById('help-modal'),
            helpTrigger: document.getElementById('help-trigger'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            historySection: document.getElementById('history-section'),
            historyList: document.getElementById('history-list')
        };

        let currentAnalysis = null;
        let history = [];

        function init() {
            loadSavedSettings();
            loadHistory();
            attachEventListeners();
        }

        function loadSavedSettings() {
            const savedKey = localStorage.getItem('gemini_api_key'); 
            if (savedKey) elements.apiKeyInput.value = savedKey;
            const savedClass = localStorage.getItem('player_class');
            if (savedClass) elements.classInput.value = savedClass;
        }

        function loadHistory() {
            const savedHistory = localStorage.getItem('horadric_history');
            if (savedHistory) {
                try {
                    history = JSON.parse(savedHistory);
                    renderHistory();
                } catch(e) { console.error("History Corrupt"); }
            }
        }

        function saveToHistory(text, rarityClass) {
            let title = "Unidentified Item";
            const match = text.match(/\*\*(.*?)\*\*/); 
            if(match && match[1]) title = match[1];

            const newItem = {
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                title: title,
                text: text,
                rarity: rarityClass,
                playerClass: elements.classInput.value || "Demo"
            };

            history.unshift(newItem);
            if (history.length > 10) history.pop();
            localStorage.setItem('horadric_history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            if (history.length === 0) {
                elements.historySection.style.display = 'none';
                return;
            }
            elements.historySection.style.display = 'block';
            elements.historyList.innerHTML = '';

            history.forEach(item => {
                const div = document.createElement('div');
                div.className = `history-item ${item.rarity ? 'h-' + item.rarity : ''}`;
                div.innerHTML = `
                    <div class="history-header">
                        <span>${item.date}</span>
                        <span>${item.playerClass}</span>
                    </div>
                    <div class="history-name">${item.title}</div>
                `;
                div.onclick = () => restoreAnalysis(item);
                elements.historyList.appendChild(div);
            });
        }

        function restoreAnalysis(item) {
            window.scrollTo({ top: 200, behavior: 'smooth' });
            displayResults(item.text, item.rarity);
        }

        window.clearHistory = function() {
            if(confirm("Clear your scan journal?")) {
                history = [];
                localStorage.removeItem('horadric_history');
                renderHistory();
            }
        };

        // --- NEW DEMO FUNCTION ---
        window.runDemo = function() {
            resetResultArea();
            elements.apiKeyInput.value = ""; 
            elements.classInput.value = "Barbarian";
            
            // UI State
            setLoadingState(true);
            
            // Simulate AI Delay
            setTimeout(() => {
                const demoText = `**The Grandfather** (Mythic Unique Two-Handed Sword) ðŸ©¸\n\nðŸ† **Score:** God Roll (S-Tier)\n\nðŸš€ **Verdict:** KEEP! This is one of the rarest items in the game. It massively multiplies your critical strike damage. Do not salvage this!`;
                const demoRarity = "mythic";
                
                setLoadingState(false);
                displayResults(demoText, demoRarity);
                
                // Optional: Save demo to history so they see how that works too
                saveToHistory(demoText, demoRarity);
            }, 1500);
        };

        function attachEventListeners() {
            elements.helpTrigger.addEventListener('click', openModal);
            elements.modalCloseBtn.addEventListener('click', closeModal);
            elements.modal.addEventListener('click', (e) => { if (e.target === elements.modal) closeModal(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && elements.modal.style.display === 'flex') closeModal(); });

            elements.fileInput.addEventListener('change', handleFileSelection);
            elements.analyzeBtn.addEventListener('click', handleAnalyze);
            elements.shareBtn.addEventListener('click', handleShare);
            elements.apiKeyInput.addEventListener('blur', validateApiKey);
        }

        function openModal() { elements.modal.style.display = 'flex'; }
        function closeModal() { elements.modal.style.display = 'none'; }

        function validateApiKey() {
            const apiKey = elements.apiKeyInput.value.trim();
            if (!apiKey) return showError(elements.apiKeyError, '');
            if (!apiKey.startsWith('AIza')) {
                elements.apiKeyInput.classList.add('error');
                return showError(elements.apiKeyError, 'Gemini keys must start with "AIza"');
            }
            elements.apiKeyInput.classList.remove('error');
            hideError(elements.apiKeyError);
            return true;
        }

        function validateFile(file) {
            if (!file) return showError(elements.imageError, 'Please select an image file');
            if (file.size > CONFIG.MAX_FILE_SIZE) return showError(elements.imageError, 'File too large.');
            if (!CONFIG.ALLOWED_MIME_TYPES.includes(file.type)) return showError(elements.imageError, 'Invalid file type.');
            hideError(elements.imageError);
            return true;
        }

        function handleFileSelection() {
            const file = elements.fileInput.files[0];
            if (!file) { elements.previewImg.style.display = 'none'; return; }
            if (!validateFile(file)) { elements.fileInput.value = ''; elements.previewImg.style.display = 'none'; return; }

            const reader = new FileReader();
            reader.onload = (e) => {
                elements.previewImg.src = e.target.result;
                elements.previewImg.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function handleAnalyze() {
            resetResultArea();

            const apiKey = elements.apiKeyInput.value.trim();
            const playerClass = elements.classInput.value;
            const file = elements.fileInput.files[0];

            if (!validateApiKey()) { elements.apiKeyInput.focus(); return; }
            if (!file || !validateFile(file)) { elements.fileInput.focus(); return; }

            localStorage.setItem('gemini_api_key', apiKey);
            localStorage.setItem('player_class', playerClass);

            setLoadingState(true);

            try {
                const base64Data = await fileToBase64(file);
                const promptText = `
                You are an expert Diablo 4 theorycrafter.
                CONTEXT: User is playing class: ${playerClass}.
                TASK: Identify the item. Check if usable by ${playerClass}. Analyze stats. Verdict: Keep/Sell/Salvage.
                OUTPUT FORMAT: Provide human-readable analysis first. Use **bold** for item name. Use emojis.
                At the very end, append exactly: ${CONFIG.JSON_DELIMITER} followed by {"rarity": "value"}.
                Valid rarities: ${CONFIG.VALID_RARITIES.join(', ')}.
                `;

                const requestBody = { "contents": [{ "parts": [ { "text": promptText }, { "inline_data": { "mime_type": file.type, "data": base64Data } } ] }] };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.GEMINI_MODEL}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || response.statusText);
                }

                const data = await response.json();
                const fullText = data.candidates[0].content.parts[0].text;
                const { displayText, rarityClass } = parseResponse(fullText);
                
                displayResults(displayText, rarityClass);
                saveToHistory(displayText, rarityClass);

            } catch (error) {
                handleAnalysisError(error);
            } finally {
                setLoadingState(false);
            }
        }

        function parseResponse(fullText) {
            const parts = fullText.split(CONFIG.JSON_DELIMITER);
            let displayText = parts[0].trim();
            let rarityClass = '';

            if (parts.length > 1) {
                try {
                    let jsonString = parts[1].trim();
                    if (jsonString.startsWith('```json')) jsonString = jsonString.replace('```json', '').replace('```', '');
                    const metadata = JSON.parse(jsonString);
                    if (metadata.rarity && CONFIG.VALID_RARITIES.includes(metadata.rarity)) {
                        rarityClass = `rarity-${metadata.rarity}`;
                    }
                } catch (e) { console.warn('Failed to parse metadata:', e); }
            }
            return { displayText, rarityClass };
        }

        function displayResults(text, rarityClass) {
            const formatted = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            elements.resultArea.innerHTML = formatted;
            elements.resultArea.className = ''; 
            if (rarityClass) elements.resultArea.classList.add(rarityClass);
            elements.resultArea.style.display = 'block';
            elements.shareBtn.classList.remove('hidden');
            currentAnalysis = text;
        }

        function handleAnalysisError(error) {
            console.error(error);
            elements.resultArea.innerText = "Error: " + error.message;
            elements.resultArea.classList.add('error-state');
            elements.resultArea.style.display = 'block';
        }

        function handleShare() {
            if (!currentAnalysis) return;
            const text = `**[Horadric AI Analysis]**\n${currentAnalysis}\n\n*Scanned via Horadric AI*`;
            navigator.clipboard.writeText(text).then(() => {
                const old = elements.shareBtn.innerText;
                elements.shareBtn.innerText = 'âœ… Copied!';
                setTimeout(() => elements.shareBtn.innerText = 'ðŸ“¢ Copy for Discord', 2000);
            });
        }

        function setLoadingState(isLoading) {
            elements.loadingDiv.style.display = isLoading ? 'block' : 'none';
            elements.analyzeBtn.disabled = isLoading;
            elements.analyzeBtn.innerText = isLoading ? 'Identifying...' : 'Identify Item';
            if (isLoading) {
                elements.resultArea.style.display = 'none';
                elements.shareBtn.classList.add('hidden');
            }
        }

        function showError(el, msg) { el.innerText = msg; el.classList.add('show'); return false; }
        function hideError(el) { el.classList.remove('show'); }
        function resetResultArea() { elements.resultArea.className = ''; elements.resultArea.innerHTML = ''; currentAnalysis = null; }

        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        init();
    </script>
</body>
</html>
