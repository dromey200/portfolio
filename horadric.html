<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI-powered Diablo 4 loot analyzer">
    <title>Horadric AI</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #d32f2f;
            --button-hover: #b71c1c;
            --disabled-color: #555;
            --modal-overlay: rgba(0, 0, 0, 0.85);
            
            /* Diablo Rarity Colors */
            --color-common: #adadad;
            --color-magic: #6969ff;
            --color-rare: #ffff00;
            --color-legendary: #ff8000;
            --color-unique: #c7b377;
            --color-mythic: #e770ff;
            --color-error: #ff3333;
            --color-success: #4caf50;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            color: var(--accent-color);
            font-family: 'Garamond', serif;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 30px; 
        }

        /* Email Capture */
        .beta-signup {
            width: 100%;
            max-width: 600px;
            margin-bottom: 25px;
            text-align: center;
            padding: 15px;
            border: 1px dashed #444;
            border-radius: 8px;
            background: rgba(255,255,255,0.03);
        }
        
        .beta-form { display: flex; gap: 10px; margin-top: 10px; justify-content: center; }

        .container {
            width: 100%;
            max-width: 600px;
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.7);
            border: 1px solid #333;
            margin-bottom: 30px;
            position: relative; 
        }

        .input-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #aaa;
            font-size: 0.9rem;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .help-icon {
            background-color: #333;
            color: #ccc;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #555;
            transition: all 0.2s;
        }

        .help-icon:hover {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        input[type="text"], input[type="password"], input[type="email"], select {
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #2c2c2c;
            color: white;
            font-size: 16px;
            width: 100%;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        input[type="file"] {
            margin-top: 5px;
            padding: 10px;
            background-color: #2c2c2c;
            border-radius: 4px;
            color: var(--text-color);
            cursor: pointer;
        }

        .input-hint {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }

        .demo-link {
            color: var(--accent-color);
            font-size: 0.85rem;
            text-decoration: underline;
            cursor: pointer;
            margin-top: 5px;
            display: inline-block;
        }
        .demo-link:hover { color: #fff; }

        .error-message {
            color: var(--color-error);
            font-size: 0.85rem;
            margin-top: 8px;
            padding: 8px 12px;
            background-color: rgba(255, 51, 51, 0.1);
            border-left: 3px solid var(--color-error);
            border-radius: 4px;
            display: none;
        }
        .error-message.show { display: block; }

        /* Buttons */
        button, .btn-link {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            display: block;
            text-decoration: none;
            box-sizing: border-box;
        }

        button:hover:not(:disabled), .btn-link:hover {
            background-color: var(--button-hover);
            transform: translateY(-1px);
        }

        button:disabled {
            background-color: var(--disabled-color);
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Action Buttons Grid */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr; /* Single column while trade is hidden */
            gap: 10px;
            margin-top: 15px;
        }

        button.secondary {
            background-color: #333;
            border: 1px solid #555;
            color: #ccc;
            margin-top: 0;
        }
        button.secondary:hover:not(:disabled) {
            background-color: #444;
            color: white;
        }
        
        /* Trade Button (Rolled back/Hidden for v2.3) */
        .trade-btn {
            background-color: #D4AF37; 
            color: #121212 !important;
            margin-top: 0;
            display: none !important; /* Back pocket */
        }

        /* Result Area */
        #result-area {
            margin-top: 25px;
            white-space: pre-wrap;
            background-color: #181818;
            padding: 20px;
            border-radius: 4px;
            border-left: 6px solid #444;
            line-height: 1.6;
            display: none;
            word-wrap: break-word;
        }

        #result-area.rarity-common { border-left-color: var(--color-common); }
        #result-area.rarity-magic { border-left-color: var(--color-magic); box-shadow: -2px 0 15px -5px var(--color-magic); }
        #result-area.rarity-rare { border-left-color: var(--color-rare); box-shadow: -2px 0 15px -5px var(--color-rare); }
        #result-area.rarity-legendary, #result-area.rarity-ancestral-legendary { border-left-color: var(--color-legendary); box-shadow: -2px 0 20px -5px var(--color-legendary); }
        #result-area.rarity-unique, #result-area.rarity-ancestral-unique { border-left-color: var(--color-unique); box-shadow: -2px 0 20px -5px var(--color-unique); }
        #result-area.rarity-mythic, #result-area.rarity-ancestral-mythic { border-left-color: var(--color-mythic); box-shadow: -2px 0 25px -5px var(--color-mythic); }
        #result-area.error-state { border-left-color: var(--color-error); box-shadow: -2px 0 20px -5px var(--color-error); }

        #loading { display: none; text-align: center; margin-top: 20px; font-style: italic; color: #888; }
        .preview-img { max-width: 100%; margin-top: 15px; border-radius: 4px; border: 1px solid #444; display: none; }

        /* History Section */
        .history-section { width: 100%; max-width: 600px; margin-top: 20px; }
        .history-title { color: #888; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; display: flex; justify-content: space-between; }
        .clear-history { color: var(--accent-color); cursor: pointer; font-size: 0.8rem; text-decoration: underline; }
        .history-list { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .history-item { background-color: #252525; border: 1px solid #333; padding: 15px; border-radius: 4px; cursor: pointer; transition: all 0.2s; border-left: 4px solid #444; }
        .history-item:hover { background-color: #333; transform: translateX(5px); }
        .history-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; color: #aaa; }
        .history-name { font-weight: bold; color: #fff; font-size: 1rem; }
        .h-rarity-legendary { border-left-color: var(--color-legendary); }
        .h-rarity-unique { border-left-color: var(--color-unique); }
        .h-rarity-mythic { border-left-color: var(--color-mythic); }
        .h-rarity-rare { border-left-color: var(--color-rare); }

        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; border: 1px solid #555; position: relative; box-shadow: 0 0 30px rgba(0, 0, 0, 0.8); }
        .modal-content h3 { margin-top: 0; color: var(--accent-color); text-transform: uppercase; }
        .modal-content ol { padding-left: 20px; line-height: 1.8; color: #ccc; }
        .modal-content code { background-color: #2c2c2c; padding: 2px 6px; border-radius: 3px; color: #4fc3f7; }
        .modal-close { position: absolute; top: 10px; right: 15px; background: none; border: none; color: #888; font-size: 28px; cursor: pointer; width: auto; }
        .modal-close:hover { color: white; }
        .highlight-link { color: #4fc3f7; text-decoration: none; border-bottom: 1px dotted #4fc3f7; }
        .hidden { display: none !important; }

        /* --- TOUR / ONBOARDING STYLES --- */
        .tour-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
        }
        
        /* The glowing box around the target */
        .tour-highlight {
            position: relative;
            z-index: 2001;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.85), 0 0 20px rgba(255, 255, 255, 0.5);
            border-radius: 4px;
            background: var(--card-bg);
            /* Ensure text remains visible */
            color: var(--text-color);
        }

        h1.tour-highlight {
            background: transparent;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.85);
        }

        /* Default Desktop Tooltip */
        .tour-tooltip {
            position: absolute;
            background: white;
            color: #121212;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            z-index: 2002;
            transition: top 0.3s ease, left 0.3s ease;
        }
        
        /* Desktop Arrow */
        .tour-tooltip::after {
            content: '';
            position: absolute;
            border-width: 8px;
            border-style: solid;
            border-color: transparent transparent white transparent;
            top: -16px; 
            left: 20px;
        }
        .tour-tooltip.tour-top::after {
            border-color: white transparent transparent transparent;
            top: 100%;
            left: 20px;
        }

        /* Welcome Modal (Centered) */
        .tour-tooltip.tour-center {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 90%;
            max-width: 400px;
            text-align: center;
            animation: none;
        }
        .tour-tooltip.tour-center::after { display: none; }

        /* --- MOBILE OPTIMIZATION: Bottom Sheet --- */
        @media (max-width: 600px) {
            .tour-tooltip {
                position: fixed !important;
                top: auto !important; /* Ignore top calc */
                bottom: 0 !important; /* Dock to bottom */
                left: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                border-radius: 16px 16px 0 0;
                transform: none !important;
                margin: 0 !important;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
                padding-bottom: 30px; /* Safe area for swipe bar */
            }
            
            /* Remove arrows on mobile */
            .tour-tooltip::after { display: none !important; }
            
            /* Ensure Welcome Modal stays centered, not bottom */
            .tour-tooltip.tour-center {
                top: 50% !important;
                bottom: auto !important;
                border-radius: 8px;
                transform: translate(-50%, -50%) !important;
                width: 90% !important;
            }
        }

        .tour-tooltip h4 { margin: 0 0 10px; color: var(--accent-color); text-transform: uppercase; font-size: 1.1rem; }
        .tour-tooltip p { margin: 0 0 20px; line-height: 1.5; font-size: 0.95rem; color: #333; }
        
        .tour-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .tour-btn { 
            background: var(--accent-color); color: white; border: none; padding: 10px 20px; 
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9rem;
        }
        .tour-btn:hover { background: var(--button-hover); }
        
        .tour-skip {
            color: #666;
            font-size: 0.85rem;
            text-decoration: underline;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }
        .tour-skip:hover { color: #333; }
    </style>
</head>
<body>

    <div id="tour-overlay" class="tour-overlay"></div>
    <div id="tour-tooltip" class="tour-tooltip hidden">
        <h4 id="tour-title">Title</h4>
        <p id="tour-text">Description</p>
        <div class="tour-actions">
            <button class="tour-skip" onclick="skipTour()">Skip Tour</button>
            <button class="tour-btn" id="tour-next-btn" onclick="nextTourStep()">Next</button>
        </div>
    </div>

    <h1 id="app-title">Horadric AI</h1>

    <div class="beta-signup">
        <label style="justify-content: center; color: var(--accent-color);">ðŸ”¥ Join the Beta List</label>
        <p style="margin: 5px 0 10px; font-size: 0.9rem; color: #bbb;">Get updates when we release new features.</p>
        <form action="https://formspree.io/f/xwvvkqbj" method="POST" class="beta-form">
            <input type="email" name="email" placeholder="Wanderer@email.com" required>
            <button type="submit" style="width: auto; padding: 12px 25px;">Join</button>
        </form>
    </div>

    <div class="container">
        <div class="input-group" id="tour-step-api">
            <label for="api-key">
                Gemini API Key
                <button id="help-trigger" class="help-icon" type="button" aria-label="Help">?</button>
            </label>
            <input type="password" id="api-key" placeholder="Paste key starting with AIza..." autocomplete="off">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <span class="input-hint">Key is free & stored locally.</span>
                <span class="demo-link" id="demo-trigger">No key? Try Demo</span>
            </div>
            <div id="api-key-error" class="error-message"></div>
        </div>

        <div class="input-group" id="tour-step-class">
            <label for="player-class">Your Class</label>
            <select id="player-class">
                <option value="Any">Select Class (Optional)</option>
                <option value="Barbarian">Barbarian</option>
                <option value="Druid">Druid</option>
                <option value="Necromancer">Necromancer</option>
                <option value="Rogue">Rogue</option>
                <option value="Sorcerer">Sorcerer</option>
                <option value="Spiritborn">Spiritborn</option>
                <option value="Paladin">Paladin</option>
            </select>
            <span class="input-hint">Select for class-specific recommendations</span>
        </div>

        <div class="input-group" id="tour-step-upload">
            <label for="image-upload">Upload Loot Screenshot</label>
            <input type="file" id="image-upload" accept="image/png,image/jpeg,image/jpg,image/webp">
            <span class="input-hint">Max 10MB. Formats: PNG, JPEG, WebP</span>
            <div id="image-error" class="error-message"></div>
            <img id="image-preview" class="preview-img" alt="Uploaded item screenshot preview">
        </div>

        <button id="analyze-btn" type="button">Identify Item</button>

        <div id="loading"><p>Consulting the archives...</p></div>

        <div id="result-area" aria-live="polite"></div>

        <div id="action-buttons" class="action-buttons hidden">
            <button id="share-btn" class="secondary" type="button">ðŸ“¢ Copy for Discord</button>
            <a id="trade-link" class="trade-btn" href="https://diablo.trade" target="_blank" onclick="handleTradeClick(event)">ðŸ’° Check Price</a>
        </div>
    </div>

    <div class="history-section" id="history-section" style="display:none;">
        <div class="history-title">
            <span>Journal (Recent Scans)</span>
            <span class="clear-history" onclick="clearHistory()">Clear All</span>
        </div>
        <div class="history-list" id="history-list"></div>
    </div>

    <div id="help-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close-btn" class="modal-close">&times;</button>
            <h3>How to get a Free Key</h3>
            <p>Horadric AI uses Google Gemini. You need a free key to use it.</p>
            <ol>
                <li>Go to <a href="https://aistudio.google.com/app/apikey" target="_blank" class="highlight-link">Google AI Studio</a>.</li>
                <li>Click <strong>"Create API Key"</strong>.</li>
                <li>Select "Create key in new project".</li>
                <li>Copy the code that starts with <code>AIza...</code></li>
                <li>Paste it into the API Key field above!</li>
            </ol>
            <div style="margin-top: 15px; font-size: 0.85rem; color: #888; border-top: 1px solid #444; padding-top: 10px;">
                <em>*Note: This key is free of charge for standard use.</em>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const CONFIG = {
            MAX_FILE_SIZE: 10 * 1024 * 1024,
            ALLOWED_MIME_TYPES: ['image/png', 'image/jpeg', 'image/jpg', 'image/webp'],
            JSON_DELIMITER: '---METADATA---',
            GEMINI_MODEL: 'gemini-2.5-flash-lite', // v2.3: Reverted to stable 1.5
            VALID_RARITIES: ['common', 'magic', 'rare', 'legendary', 'unique', 'mythic']
        };

        // --- DOM ELEMENTS ---
        const elements = {
            apiKeyInput: document.getElementById('api-key'),
            classInput: document.getElementById('player-class'),
            fileInput: document.getElementById('image-upload'),
            resultArea: document.getElementById('result-area'),
            loadingDiv: document.getElementById('loading'),
            previewImg: document.getElementById('image-preview'),
            shareBtn: document.getElementById('share-btn'),
            tradeLink: document.getElementById('trade-link'), 
            actionButtons: document.getElementById('action-buttons'),
            analyzeBtn: document.getElementById('analyze-btn'),
            demoTrigger: document.getElementById('demo-trigger'),
            modal: document.getElementById('help-modal'),
            helpTrigger: document.getElementById('help-trigger'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            historySection: document.getElementById('history-section'),
            historyList: document.getElementById('history-list'),
            // Tour Elements
            tourOverlay: document.getElementById('tour-overlay'),
            tourTooltip: document.getElementById('tour-tooltip'),
            tourTitle: document.getElementById('tour-title'),
            tourText: document.getElementById('tour-text'),
            tourNextBtn: document.getElementById('tour-next-btn')
        };

        let currentAnalysis = null;
        let currentTradeQuery = "";
        let history = [];
        let tourStep = 0;

        function init() {
            loadSavedSettings();
            loadHistory();
            attachEventListeners();
            checkTour(); 
        }

        // --- TOUR LOGIC (MOBILE OPTIMIZED v2.3) ---
        function checkTour() {
            if (!localStorage.getItem('horadric_tour_complete')) {
                startTour();
            }
        }

        function startTour() {
            elements.tourOverlay.style.display = 'block';
            elements.tourTooltip.classList.remove('hidden');
            tourStep = 0; 
            showTourStep();
        }

        function showTourStep() {
            // Cleanup previous state
            document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
            elements.tourTooltip.classList.remove('tour-center'); 
            elements.tourTooltip.classList.remove('tour-top');

            if (tourStep === 0) {
                // Step 0: Welcome Modal (Centered)
                elements.tourTooltip.classList.add('tour-center');
                elements.tourTitle.innerText = "Welcome to Horadric AI ðŸ˜ˆ";
                elements.tourText.innerText = "I am your AI-powered loot consultant for Diablo 4. \n\nI can identify items and tell you if a drop is 'Trash' or 'Treasure' based on your class.";
                elements.tourNextBtn.innerText = "Take the Tour";
                
            } else if (tourStep === 1) {
                const target = document.getElementById('tour-step-api');
                target.classList.add('tour-highlight');
                positionTooltip(target);
                elements.tourTitle.innerText = "1. The Brain ðŸ§ ";
                elements.tourText.innerText = "You need a free Google Gemini Key. Click the '?' button for a guide on how to get one.\n\nDon't have a key? Click 'Try Demo' to see it in action.";
                elements.tourNextBtn.innerText = "Next";
                
            } else if (tourStep === 2) {
                const target = document.getElementById('tour-step-class');
                target.classList.add('tour-highlight');
                positionTooltip(target);
                elements.tourTitle.innerText = "2. The Context ðŸ›¡ï¸";
                elements.tourText.innerText = "Select your class! I'm smart enough to tell you if an item is junk for YOU, but valuable for TRADING.";
                
            } else if (tourStep === 3) {
                const target = document.getElementById('tour-step-upload');
                target.classList.add('tour-highlight');
                positionTooltip(target);
                elements.tourTitle.innerText = "3. The Eyes ðŸ‘ï¸";
                elements.tourText.innerText = "Upload a screenshot or photo of your item. I'll identify stats, rarity, and value instantly.";
                elements.tourNextBtn.innerText = "Finish";
                
            } else {
                endTour();
            }
        }

        window.nextTourStep = function() {
            tourStep++;
            showTourStep();
        };

        window.skipTour = function() {
            endTour();
        };

        function endTour() {
            elements.tourOverlay.style.display = 'none';
            elements.tourTooltip.classList.add('hidden');
            document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
            localStorage.setItem('horadric_tour_complete', 'true');
        }

        function positionTooltip(targetElement) {
            if (!targetElement) return;

            // Ensure visibility
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Mobile Check: If screen < 600px, DO NOT calculate top/left.
            // The CSS media query handles fixed bottom docking automatically.
            if (window.innerWidth <= 600) return;

            const rect = targetElement.getBoundingClientRect();
            const tooltip = elements.tourTooltip;
            
            // Get viewport dimensions
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const tooltipHeight = tooltip.offsetHeight || 200; 
            
            let top = rect.bottom + 15; 
            let left = rect.left;
            let arrowClass = ''; 

            // Desktop logic: Prevent falling off right edge
            if (left + 300 > viewportWidth) {
                left = viewportWidth - 320; 
            }

            // Apply calculated positions + scroll offset
            const scrollY = window.scrollY || window.pageYOffset;
            
            tooltip.style.top = (top + scrollY) + 'px';
            tooltip.style.left = left + 'px';
            
            // Reset arrow classes
            tooltip.classList.remove('tour-top');
            if(arrowClass) tooltip.classList.add(arrowClass);
        }

        // --- CORE LOGIC ---
        function loadSavedSettings() {
            const savedKey = localStorage.getItem('gemini_api_key'); 
            if (savedKey) elements.apiKeyInput.value = savedKey;
            const savedClass = localStorage.getItem('player_class');
            if (savedClass) elements.classInput.value = savedClass;
        }

        // --- DEMO MODE ---
        function runDemo() {
            resetResultArea();
            elements.apiKeyInput.value = ""; 
            elements.classInput.value = "Barbarian";
            setLoadingState(true);
            
            setTimeout(() => {
                const demoText = `**The Grandfather** (Mythic Unique Two-Handed Sword) ðŸ©¸\n\nðŸ† **Score:** God Roll (S-Tier)\n\nðŸš€ **Verdict:** KEEP! This is one of the rarest items in the game.`;
                const demoRarity = "mythic";
                const demoTrade = "The Grandfather Mythic Unique";
                
                setLoadingState(false);
                displayResults(demoText, demoRarity, demoTrade);
                saveToHistory(demoText, demoRarity, demoTrade);
            }, 1500);
        }

        // --- ANALYSIS ---
        async function handleAnalyze() {
            resetResultArea();
            const apiKey = elements.apiKeyInput.value.trim();
            const playerClass = elements.classInput.value;
            const file = elements.fileInput.files[0];

            if (!apiKey) { elements.apiKeyInput.focus(); return; }
            if (!file) { elements.fileInput.focus(); return; }

            localStorage.setItem('gemini_api_key', apiKey);
            localStorage.setItem('player_class', playerClass);
            setLoadingState(true);

            try {
                const base64Data = await fileToBase64(file);
                const promptText = `
                Role: Diablo 4 Expert.
                Context: User is ${playerClass}.
                Task: Analyze item in image.
                Output Format:
                1. Human readable analysis (Bold Name, Verdict, Reasoning).
                2. At the END, append exactly: ${CONFIG.JSON_DELIMITER} followed by a JSON object.
                JSON Structure:
                {
                    "rarity": "legendary" (or unique, mythic, rare),
                    "trade_query": "ItemType Affix1 Affix2" (e.g. "Ancestral Sword Critical Damage Strength" OR "Tempest Roar" if unique)
                }
                `;

                const requestBody = { "contents": [{ "parts": [ { "text": promptText }, { "inline_data": { "mime_type": file.type, "data": base64Data } } ] }] };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.GEMINI_MODEL}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) throw new Error("API Error");

                const data = await response.json();
                const fullText = data.candidates[0].content.parts[0].text;
                const { displayText, rarityClass, tradeQuery } = parseResponse(fullText);
                
                displayResults(displayText, rarityClass, tradeQuery);
                saveToHistory(displayText, rarityClass, tradeQuery);

            } catch (error) {
                handleAnalysisError(error);
            } finally {
                setLoadingState(false);
            }
        }

        // --- PARSING ---
        function parseResponse(fullText) {
            const parts = fullText.split(CONFIG.JSON_DELIMITER);
            let displayText = parts[0].trim();
            let rarityClass = '';
            let tradeQuery = '';

            if (parts.length > 1) {
                try {
                    let jsonString = parts[1].trim();
                    if (jsonString.startsWith('```json')) jsonString = jsonString.replace('```json', '').replace('```', '');
                    const metadata = JSON.parse(jsonString);
                    if (metadata.rarity) rarityClass = `rarity-${metadata.rarity}`;
                    if (metadata.trade_query) tradeQuery = metadata.trade_query;
                } catch (e) { console.warn('JSON Parse Error', e); }
            }
            return { displayText, rarityClass, tradeQuery };
        }

        function displayResults(text, rarityClass, tradeQuery) {
            const formatted = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            elements.resultArea.innerHTML = formatted;
            elements.resultArea.className = ''; 
            if (rarityClass) elements.resultArea.classList.add(rarityClass);
            elements.resultArea.style.display = 'block';
            
            elements.actionButtons.classList.remove('hidden');
            currentAnalysis = text;
            currentTradeQuery = tradeQuery;
            
            if(elements.tradeLink) elements.tradeLink.href = "[https://diablo.trade](https://diablo.trade)";
        }

        // --- TRADE CLICK HANDLER (Hidden v2.3) ---
        window.handleTradeClick = function(e) {
            if (currentTradeQuery) {
                navigator.clipboard.writeText(currentTradeQuery);
                const originalText = elements.tradeLink.innerText;
                elements.tradeLink.innerText = "âœ… Copied! Opening...";
                setTimeout(() => elements.tradeLink.innerText = originalText, 2000);
            }
        };

        function handleShare() {
            const text = `**[Horadric AI]**\n${currentAnalysis}\n*Scanned via Horadric AI*`;
            navigator.clipboard.writeText(text).then(() => {
                const old = elements.shareBtn.innerText;
                elements.shareBtn.innerText = 'âœ… Copied!';
                setTimeout(() => elements.shareBtn.innerText = 'ðŸ“¢ Copy for Discord', 2000);
            });
        }

        // --- HISTORY ---
        function loadHistory() {
            const saved = localStorage.getItem('horadric_history');
            if (saved) { history = JSON.parse(saved); renderHistory(); }
        }

        function saveToHistory(text, rarity, trade) {
            let title = "Item";
            const match = text.match(/\*\*(.*?)\*\*/);
            if(match) title = match[1];

            history.unshift({
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                title: title,
                text: text,
                rarity: rarity,
                trade: trade,
                playerClass: elements.classInput.value || "Demo"
            });
            if (history.length > 10) history.pop();
            localStorage.setItem('horadric_history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            if (history.length === 0) { elements.historySection.style.display = 'none'; return; }
            elements.historySection.style.display = 'block';
            elements.historyList.innerHTML = '';
            history.forEach(item => {
                const div = document.createElement('div');
                div.className = `history-item ${item.rarity ? 'h-' + item.rarity : ''}`;
                div.innerHTML = `<div class="history-header"><span>${item.date}</span><span>${item.playerClass}</span></div><div class="history-name">${item.title}</div>`;
                div.onclick = () => {
                    window.scrollTo({ top: 200, behavior: 'smooth' });
                    displayResults(item.text, item.rarity, item.trade);
                };
                elements.historyList.appendChild(div);
            });
        }

        window.clearHistory = function() {
            if(confirm("Clear history?")) { history = []; localStorage.removeItem('horadric_history'); renderHistory(); }
        };

        // --- UTILS ---
        function attachEventListeners() {
            elements.helpTrigger.addEventListener('click', () => elements.modal.style.display = 'flex');
            elements.modalCloseBtn.addEventListener('click', () => elements.modal.style.display = 'none');
            elements.fileInput.addEventListener('change', handleFileSelection);
            elements.analyzeBtn.addEventListener('click', handleAnalyze);
            elements.shareBtn.addEventListener('click', handleShare);
            elements.apiKeyInput.addEventListener('blur', validateApiKey);
            if (elements.demoTrigger) elements.demoTrigger.addEventListener('click', runDemo);
        }

        function handleFileSelection() {
            const file = elements.fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { elements.previewImg.src = e.target.result; elements.previewImg.style.display = 'block'; };
                reader.readAsDataURL(file);
            }
        }

        function setLoadingState(isLoading) {
            elements.loadingDiv.style.display = isLoading ? 'block' : 'none';
            elements.analyzeBtn.disabled = isLoading;
            elements.analyzeBtn.innerText = isLoading ? 'Identifying...' : 'Identify Item';
            if (isLoading) { elements.resultArea.style.display = 'none'; elements.actionButtons.classList.add('hidden'); }
        }

        function handleAnalysisError(error) {
            elements.resultArea.innerText = "Error: " + error.message;
            elements.resultArea.classList.add('error-state');
            elements.resultArea.style.display = 'block';
        }

        function validateApiKey() {
            const apiKey = elements.apiKeyInput.value.trim();
            if (!apiKey) return showError(elements.apiKeyError, '');
            if (!apiKey.startsWith('AIza')) {
                elements.apiKeyInput.classList.add('error');
                return showError(elements.apiKeyError, 'Gemini keys must start with "AIza"');
            }
            elements.apiKeyInput.classList.remove('error');
            hideError(elements.apiKeyError);
            return true;
        }

        function showError(el, msg) { el.innerText = msg; el.classList.add('show'); return false; }
        function hideError(el) { el.classList.remove('show'); }
        function resetResultArea() { elements.resultArea.className = ''; elements.resultArea.innerHTML = ''; currentAnalysis = null; }

        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        init();
    </script>
</body>
</html>
